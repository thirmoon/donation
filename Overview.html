<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>慈善亭 | 重大建設捐獻</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
  <link rel="stylesheet" href="./src/css/overview.css">


  <script src="https://www.gstatic.com/firebasejs/4.11.0/firebase.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@mdi/font@6.x/css/materialdesignicons.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">
  <script src="./dist/vuefire.js"></script>

</head>

<body>

  <div id="app">
    <section id="admin-wrapper">
      <div id="form-wrapper">
        <h1 class="page-title">慈善亭 | 重大建設捐獻</h1>
        <h1 class="page-title">
          <a href="Create.html">新增</a> |
          <a href="Overview.html">總覽</a> |
          <a href="Download.html">下載</a> |
        </h1>
      </div>

    </section>
    <ul>
      <div id="app-table"></div>
    </ul>
  </div>
  <script type="text/x-template" id="app-template">
    <v-app id="inspire">
      <ul>
      <v-btn elevation="2"  v-on:click="addByName" >以姓名新增</v-btn>
      <v-btn elevation="2"  v-on:click="addByAddress" >以地址新增</v-btn>
      </ul>
      <v-card>
        <v-card-title>
          <v-text-field v-model="search" append-icon="mdi-magnify" label="搜尋" single-line hide-details>
          </v-text-field>
        </v-card-title>
        <v-data-table 
          :headers="headers" 
          :items="overviewData" 
          :search="search" 
          class="elevation-1" 
          item-key="key"
          fixed-header
          height="400px"
          :items-per-page="20">   
          <template v-slot:item.name="{ item }">
            <input :name="item.name"  id="overview_name" v-model.trim="item.name" maxlength="8">
          </template>
          <template v-slot:item.address="{ item }">
            <input  :name="item.address" id="overview_address" v-model.trim="item.address">
          </template>
          <template v-slot:item.phone="{ item }">
            <input  :name="item.phone" v-model.trim="item.phone" id="overview_phone">
          </template>
          <template v-slot:item.amount="{ item }">
            <input  :name="item.amount" v-model.trim="item.amount" id="overview_amount">
          </template>
          <template v-slot:item.memo="{ item }">
            <input  :name="item.memo" v-model.trim="item.memo">
          </template>
          <template v-slot:item.actions="{ item }">
            <v-btn elevation="2"  v-on:click="updateDonation(item)" >更新</v-btn>
            <v-btn elevation="2"  v-on:click="removeDonation(item)" >刪除</v-btn>
          </template>
        </v-data-table>
      </v-card>
    </v-app>
  </script>

  <script>
    /* global Vue, firebase */

    let config = {
      apiKey: 'AIzaSyBJykOkltgTEmq5bTCA5pxUUCI52Tghx6g',
      authDomain: 'light-1a6d4.firebaseapp.com',
      databaseURL: 'https://light-1a6d4.firebaseio.com/',
      projectId: 'light-1a6d4',
      storageBucket: 'light-1a6d4.appspot.com',
      messagingSenderId: '66654715141'
    }

    let db = firebase.initializeApp(config).database()
    let donationRef = db.ref('Donation')
    const App = {
      template: '#app-template',
      data() {
        return {
          overviewData: [],
          headers: [
            { text: '功德主姓名', value: 'name' },
            { text: '地址', value: 'address' },
            { text: '電話', value: 'phone' },
            { text: '金額', value: 'amount' },
            { text: '備註', value: 'memo' },
            { text: '操作', value: 'actions' },


          ],
          search: ''
        }
      },
      firebase: {
        Donations: donationRef.limitToLast(25),
      },
      beforeMount() {
        this.loadData()
      },
      methods: {
        loadData: function () {
          let self = this;
          this.overviewData = []
          donationRef.once("value", function (snapshot) {
            snapshot.forEach(function (data) {
              let donation = data.val();
              donation.key = data.key;
              self.overviewData.push(donation);
            });

            self.overviewData = self.overviewData.sort(function (a, b) {
              return a.address > b.address ? -1 : 1;
            });

          });
        },
        addByName: function () {
          location.href = 'Create.html?name=' + this.search;
        },
        addByAddress: function () {
          location.href = 'Create.html?address=' + this.search;
        },
        updateDonation: function (data) {
          data.modifyTime = Date.now();
          let key = data.key;
          delete data.key;
          donationRef.child(key).set(data);
          alert('更新完成')
          this.loadData()
        },
        removeDonation: function (data) {
          donationRef.child(data.key).remove();
          alert('刪除完成')
          this.loadData()
        },

      }
    }
    new Vue({
      vuetify: new Vuetify(),
      render: h => h(App)
    }).$mount('#app-table')



  </script>
</body>

</html>
